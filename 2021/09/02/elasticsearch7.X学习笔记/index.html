<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hufanglei.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"scrollpercent":true,"onmobile":false},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="markdown版本引言什么是elasticsearch？ ElasticSearch是一个分布式，高性能、高可用、可伸缩的搜索和分析系统  什么是Elastic Stack？ Elastic Stack,前身缩写是ELK，就是ElasticSearch + LogStash + Kibana ES的使用场景:  网上商场,搜索商品. ES配合logstash,kibana,日志分析.  为什">
<meta property="og:type" content="blog">
<meta property="og:title" content="elasticsearch7.X学习笔记">
<meta property="og:url" content="https://hufanglei.github.io/2021/09/02/elasticsearch7.X%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="markdown版本引言什么是elasticsearch？ ElasticSearch是一个分布式，高性能、高可用、可伸缩的搜索和分析系统  什么是Elastic Stack？ Elastic Stack,前身缩写是ELK，就是ElasticSearch + LogStash + Kibana ES的使用场景:  网上商场,搜索商品. ES配合logstash,kibana,日志分析.  为什">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-02T15:48:32.000Z">
<meta property="article:modified_time" content="2025-01-24T03:37:59.000Z">
<meta property="article:author" content="胡方雷">
<meta property="article:tag" content="elasticsearch 数据库">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://hufanglei.github.io/2021/09/02/elasticsearch7.X%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hufanglei.github.io/2021/09/02/elasticsearch7.X%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","path":"2021/09/02/elasticsearch7.X学习笔记/","title":"elasticsearch7.X学习笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>elasticsearch7.X学习笔记 | 个人博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">个人博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录生活中的点点滴滴</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">398</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">105</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">594</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#markdown%E7%89%88%E6%9C%AC"><span class="nav-text">markdown版本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-text">引言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-elasticsearch%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">1.elasticsearch基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%EF%BC%88NRT%EF%BC%89"><span class="nav-text">近实时（NRT）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3"><span class="nav-text">文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-text">索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B"><span class="nav-text">类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9"><span class="nav-text">节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87"><span class="nav-text">分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E7%89%87%E5%89%AF%E6%9C%AC"><span class="nav-text">分片副本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-text">倒排索引</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-linux-ES%E7%9A%84%E5%AE%89%E8%A3%85-elasticsearch-7-3-2"><span class="nav-text">2.linux ES的安装(elasticsearch-7.3.2)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="nav-text">修改配置</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-elasticsearch-head-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-text">3.elasticsearch-head 的安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-kibana%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-text">4.kibana的安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%99%E8%AF%B7%E6%B1%82%E5%8E%9F%E7%90%86"><span class="nav-text">写请求原理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-RESTful-API"><span class="nav-text">5.RESTful API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E7%A9%BA%E7%B4%A2%E5%BC%95"><span class="nav-text">1.创建空索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-text">2.删除索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-text">3.插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="nav-text">4.更新数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1%E5%B1%80%E9%83%A8%E6%9B%B4%E6%96%B0%EF%BC%9A"><span class="nav-text">4.1局部更新：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="nav-text">5.删除数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-0%E6%A0%B9%E6%8D%AEid%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="nav-text">6.0根据id搜索数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1%E6%90%9C%E7%B4%A2%E5%85%A8%E9%83%A8%E6%95%B0%E6%8D%AE"><span class="nav-text">6.1搜索全部数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="nav-text">6.2关键字搜索数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3DSL%E6%90%9C%E7%B4%A2"><span class="nav-text">6.3DSL搜索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="nav-text">6.4高亮显示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5%E8%81%9A%E5%90%88"><span class="nav-text">6.5聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#avg-%EF%BC%9A%E5%B9%B3%E5%9D%87%E5%80%BC"><span class="nav-text">avg ：平均值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#max%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%80%BC"><span class="nav-text">max：最大值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#min%EF%BC%9A%E6%9C%80%E5%B0%8F%E5%80%BC"><span class="nav-text">min：最小值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sum%EF%BC%9A%E6%B1%82%E5%92%8C"><span class="nav-text">sum：求和</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cardinality-%E5%8E%BB%E9%87%8D%E7%BB%9F%E8%AE%A1"><span class="nav-text">cardinality : 去重统计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#extended-stats%E6%89%A9%E5%B1%95%E7%BB%9F%E8%AE%A1%E8%81%9A%E5%90%88"><span class="nav-text">extended_stats扩展统计聚合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#value-count%E5%80%BC%E8%AE%A1%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="nav-text">value_count值计数统计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#terms%E8%AF%8D%E8%81%9A%E5%90%88"><span class="nav-text">terms词聚合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#top-hits%E6%9C%80%E9%AB%98%E5%8C%B9%E9%85%8D%E6%9D%83%E5%80%BC%E8%81%9A%E5%90%88"><span class="nav-text">top_hits最高匹配权值聚合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#range%E8%8C%83%E5%9B%B4"><span class="nav-text">range范围</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-6%E6%9F%A5%E8%AF%A2%E5%93%8D%E5%BA%94"><span class="nav-text">6.6查询响应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-7%E6%8C%87%E5%AE%9A%E5%93%8D%E5%BA%94%E5%AD%97%E6%AE%B5"><span class="nav-text">6.7指定响应字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-8%E5%8E%BB%E6%8E%89%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-text">6.8去掉元数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-9%E5%88%A4%E6%96%AD%E6%96%87%E6%A1%A3%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-text">6.9判断文档是否存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-text">7.批量操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2"><span class="nav-text">7.1批量查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="nav-text">7.2批量插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="nav-text">7.3批量删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9"><span class="nav-text">7.4批量修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-text">8.分页查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E4%B8%80"><span class="nav-text">分页一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E4%BA%8C"><span class="nav-text">分页二</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E4%B8%89"><span class="nav-text">分页三</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-%E6%98%A0%E5%B0%84"><span class="nav-text">9.映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-%E7%BB%93%E6%9E%84%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.结构化查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-1term%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.1term查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-2terms%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.2terms查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3range%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.3range查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-4exists%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.4exists查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-5-match%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.5 match查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-6-bool%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.6  bool查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-7%E8%BF%87%E6%BB%A4%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.7过滤查询</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-text">批量导入测试数据</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="nav-text">6.中文分词</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#6-0-Analyzer-%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-text">6.0 Analyzer 的组成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-1elasticsearch%E5%86%85%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-text">6.1elasticsearch内置分词器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-2%E5%88%86%E8%AF%8Dapi"><span class="nav-text">6.2分词api</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-3ik%E5%88%86%E8%AF%8D%E5%99%A8%E5%AE%89%E8%A3%85"><span class="nav-text">6.3ik分词器安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-text">6.4拼音分词器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-5%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-text">6.5自定义分词器</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2"><span class="nav-text">7.全文搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-1%E6%9E%84%E5%BB%BA%E6%95%B0%E6%8D%AE"><span class="nav-text">7.1构建数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-2%E5%8D%95%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-text">7.2单词搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-3%E5%A4%9A%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-text">7.3多词搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-4%E7%BB%84%E5%90%88%E6%90%9C%E7%B4%A2"><span class="nav-text">7.4组合搜索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-5%E6%9D%83%E9%87%8D"><span class="nav-text">7.5权重</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-Elasticsearch%E9%9B%86%E7%BE%A4"><span class="nav-text">8.Elasticsearch集群</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#192-168-204-209-elasticsearch-yml"><span class="nav-text">192.168.204.209  elasticsearch.yml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#192-168-204-203-elasticsearch-yml"><span class="nav-text">192.168.204.203  elasticsearch.yml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#192-168-204-108-elasticsearch-yml"><span class="nav-text">192.168.204.108  elasticsearch.yml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4-%E4%B8%80"><span class="nav-text">一台机器搭建集群(一)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#elasticsearch-7-3-2-node1"><span class="nav-text">elasticsearch-7.3.2_node1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#elasticsearch-7-3-2-node2"><span class="nav-text">elasticsearch-7.3.2_node2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#elasticsearch-7-3-2-node3"><span class="nav-text">elasticsearch-7.3.2_node3</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4-%E4%BA%8C"><span class="nav-text">一台机器搭建集群(二)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81pdf%E7%89%88"><span class="nav-text">二、pdf版</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="胡方雷"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">胡方雷</p>
  <div class="site-description" itemprop="description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">594</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">105</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">398</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hufanglei" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hufanglei" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://hufanglei.blog.csdn.net/" title="CSDN → https:&#x2F;&#x2F;hufanglei.blog.csdn.net" rel="noopener me" target="_blank"><i class="crosshairs fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:690328661@qq.com" title="E-Mail → mailto:690328661@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1518938&auto=1&height=66"></iframe>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title">
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">Web前端导航</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://www.uisdc.com/" title="http:&#x2F;&#x2F;www.uisdc.com&#x2F;" rel="noopener" target="_blank">优设</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://www.zhangxinxu.com/" title="http:&#x2F;&#x2F;www.zhangxinxu.com&#x2F;" rel="noopener" target="_blank">牛人文档</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端技术学院</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">google前端开发基础</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hufanglei.github.io/2021/09/02/elasticsearch7.X%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="胡方雷">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="elasticsearch7.X学习笔记 | 个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          elasticsearch7.X学习笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-02 23:48:32" itemprop="dateCreated datePublished" datetime="2021-09-02T23:48:32+08:00">2021-09-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-01-24 11:37:59" itemprop="dateModified" datetime="2025-01-24T11:37:59+08:00">2025-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>38k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>34 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><span id="more"></span>

<h1 id="markdown版本"><a href="#markdown版本" class="headerlink" title="markdown版本"></a>markdown版本</h1><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p><strong>什么是elasticsearch？</strong></p>
<p>ElasticSearch是一个分布式，高性能、高可用、可伸缩的搜索和分析系统 </p>
<p><strong>什么是Elastic Stack？</strong></p>
<p>Elastic Stack,前身缩写是ELK，就是ElasticSearch + LogStash + Kibana</p>
<p>ES的使用场景:</p>
<ul>
<li>网上商场,搜索商品.</li>
<li>ES配合logstash,kibana,日志分析.</li>
</ul>
<p><strong>为什么要使用elasticsearch？</strong></p>
<p>假设用数据库做搜索，当用户在搜索框输入“四川火锅”时，数据库通常只能把这四个字去进行全部匹配。可是在文本中，可能会出现“推荐四川好吃的火锅”，这时候就没有结果了。</p>
<h1 id="1-elasticsearch基本概念"><a href="#1-elasticsearch基本概念" class="headerlink" title="1.elasticsearch基本概念"></a>1.elasticsearch基本概念</h1><h4 id="近实时（NRT）"><a href="#近实时（NRT）" class="headerlink" title="近实时（NRT）"></a>近实时（NRT）</h4><p>ES是一个近实时的搜索引擎（平台），代表着从添加数据到能被搜索到只有很少的延迟。（大约是1s）</p>
<h4 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h4><p>Elasticsearch是面向文档的，文档是所有可搜索数据的最小单元。可以把文档理解为关系型数据库中的一条记录。文档会被序列化成json格式，保存在Elasticsearch中。同样json对象由字段组成，给个字段都有自己的类型（字符串，数值，布尔，二进制，日期范围类型）。当我们创建文档时，如果不指定类型，Elasticsearch会帮我们自动匹配类型。每个文档都一个ID，你可以自己指定，也可以让Elasticsearch自动生成。json格式，支持数组&#x2F;嵌套,在一个index&#x2F;type里面，你可以存储任意多的文档。注意，尽管一个文档，物理上存在于一个索引之中，文档必须被索引&#x2F;赋予一个索引的type。</p>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><p>索引是具有某种相似特性的文档集合。例如，您可以拥有客户数据的索引、产品目录的另一个索引以及订单数据的另一个索引。索引由一个名称（必须全部是小写）标识。在单个集群中，您可以定义任意多个索引。Index体现了逻辑空间的概念，每个索引都有自己的mapping定义，用于定义包含文档的字段名和字段类型。Index体现了物理空间的概念，索引中的数据分散在shard上。可以将其暂时理解为 MySql中的 database。</p>
<p>索引的mapping和setting</p>
<ol>
<li>mapping：定义文档字段的类型</li>
<li>setting：定义不同数据的分布</li>
</ol>
<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><p>一个索引可以有多个类型。例如一个索引下可以有文章类型，也可以有用户类型，也可以有评论类型。在一个索引中不能再创建多个类型，在以后的版本中将删除类型的整个概念。</p>
<p>从6.0开始，type已经被逐渐废弃。在7.0之前，一个index可以设置多个types。7.0开始一个索引只能创建一个type（_doc）</p>
<h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><p>节点是一个Elasticsearch实例，本质上就是一个java进程，节点也有一个名称（默认是随机分配的），当然也可以通过配置文件配置，或者在启动的时候，-E  node.name&#x3D;node1指定。此名称对于管理目的很重要，因为您希望确定网络中的哪些服务器对应于ElasticSearch集群中的哪些节点。</p>
<p>在Elasticsearch中，节点的类型主要分为如下几种：</p>
<ul>
<li><p><strong>master eligible节点：</strong></p>
<p> 每个节点启动后，默认就是master eligible节点，可以通过node.master: false  禁止</p>
<p>master eligible可以参加选主流程，成为master节点</p>
<p>当第一个节点启动后，它会将自己选为master节点</p>
<p>每个节点都保存了集群的状态，只有master节点才能修改集群的状态信息</p>
</li>
<li><p><strong>data节点</strong></p>
<p>可以保存数据的节点。负责保存分片数据，在数据扩展上起到了至关重要的作用</p>
</li>
<li><p><strong>Coordinating 节点</strong></p>
<p>负责接收客户端请求，将请求发送到合适的节点，最终把结果汇集到一起</p>
<p>每个节点默认都起到了Coordinating node的职责</p>
</li>
</ul>
<p>开发环境中一个节点可以承担多个角色，生产环境中，建议设置单一的角色，可以提高性能等</p>
<h4 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h4><p>索引可能存储大量数据，这些数据可能会超出单个节点的硬件限制。例如，占用1TB磁盘空间的10亿个文档的单个索引可能不适合单个节点的磁盘，或者速度太慢，无法单独满足单个节点的搜索请求。</p>
<p>为了解决这个问题，ElasticSearch提供了将索引细分为多个片段（称为碎片）的能力。创建索引时，只需定义所需的碎片数量。每个分片（shard）本身就是一个完全功能性和独立的“索引”，可以托管在集群中的任何节点上。</p>
<p>为什么要分片?</p>
<ul>
<li>它允许您水平拆分&#x2F;缩放内容量</li>
<li>它允许您跨碎片（可能在多个节点上）分布和并行操作，从而提高性能&#x2F;吞吐量</li>
</ul>
<p>如何分配分片以及如何将其文档聚合回搜索请求的机制完全由ElasticSearch管理，并且对作为用户的您是透明的。主分片数在索引创建时指定，后续不允许修改，除非Reindex</p>
<h5 id="分片副本"><a href="#分片副本" class="headerlink" title="分片副本"></a>分片副本</h5><p>在随时可能发生故障的网络&#x2F;云环境中，非常有用，强烈建议在碎片&#x2F;节点以某种方式脱机或因任何原因消失时使用故障转移机制。为此，ElasticSearch允许您将索引分片的一个或多个副本复制成所谓的副本分片，简称为副本分片。</p>
<p>为什么要有副本？</p>
<ul>
<li>当分片&#x2F;节点发生故障时提供高可用性。因此，需要注意的是，副本分片永远不会分配到复制它的原始&#x2F;主分片所在的节点上。</li>
<li>允许您扩展搜索量&#x2F;吞吐量，因为可以在所有副本上并行执行搜索。</li>
</ul>
<p>总而言之，每个索引可以分割成多个分片。索引也可以零次（意味着没有副本）或多次复制。复制后，每个索引将具有主分片（从中复制的原始分片）和副本分片（主分片的副本）。</p>
<p>可以在创建索引时为每个索引定义分片和副本的数量。创建索引后，您还可以随时动态更改副本的数量。您可以使用收缩和拆分API更改现有索引的分片数量，建议在创建索引时就考虑好分片和副本的数量。</p>
<p>默认情况下，ElasticSearch中的每个索引都分配一个主分片和一个副本，这意味着如果集群中至少有两个节点，则索引将有一个主分片和另一个副本分片（一个完整副本），每个索引总共有两个分片。</p>
<h5 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h5><ul>
<li>DocID：出现某单词的文档ID</li>
<li>TF(词频)：单词在该文档中出现的次数</li>
<li>POS：单词在文档中的位置</li>
</ul>
<h1 id="2-linux-ES的安装-elasticsearch-7-3-2"><a href="#2-linux-ES的安装-elasticsearch-7-3-2" class="headerlink" title="2.linux ES的安装(elasticsearch-7.3.2)"></a>2.linux ES的安装(elasticsearch-7.3.2)</h1><p>1.下载elasticsearch-7.3.2 tar包  下载地址<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<p>2.上传到linux，解压  tar -zxvf   elasticsearch-7.3.2-linux-x86_64.tar.gz</p>
<p>3.进入解压后的 elasticsearch-7.3.2文件夹的bin目录下  执行.&#x2F;elasticsearch</p>
<p>这个错误，是因为使用root用户启动elasticsearch，elasticsearch是不允许使用root用户启动的</p>
<p>在6.xx之前，可以通过root用户启动。但是发现黑客可以透过elasticsearch获取root用户密码，所以为了安全性，在6版本之后就不能通过root启动elasticsearch</p>
<p>解决方案如下：</p>
<p>groupadd taibai<br>useradd taibai -g taibai</p>
<p>cd &#x2F;opt     [elasticsearch-7.3.2所在路径]</p>
<p>chown -R taibai:taibai elasticsearch-7.3.2</p>
<h5 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h5><p>1、调整jvm内存大小(机器内存够也可不调整)</p>
<p> <strong>vim config&#x2F;jvm.options</strong> </p>
<p>-Xms512m<br>-Xmx512m</p>
<p>2、修改network配置，支持通过ip访问</p>
<p><strong>vim config&#x2F;elasticsearch.yml</strong> </p>
<p>cluster.name&#x3D;luban</p>
<p>node.name&#x3D;node-1</p>
<p>network.host: 0.0.0.0</p>
<p>http.port: 9200</p>
<p>cluster.initial_master_nodes: [“node-1”]</p>
<p>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]<br>vm最大虚拟内存,max_map_count[65530]太低，至少增加到[262144]</p>
<p><strong>vim &#x2F;etc&#x2F;sysctl.conf</strong> </p>
<p>vm.max_map_count&#x3D;655360 </p>
<p>sysctl -p   使配置生效 </p>
<p>descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]</p>
<p>最大文件描述符[4096]对于elasticsearch进程可能太低，至少增加到[65536]</p>
<p><strong>vim &#x2F;etc&#x2F;security&#x2F;limits.conf</strong> </p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 4096</span><br><span class="line"></span><br><span class="line">* 所有用户</span><br><span class="line">nofile - 打开文件的最大数目</span><br><span class="line">noproc - 进程的最大数目</span><br><span class="line">soft 指的是当前系统生效的设置值</span><br><span class="line">hard 表明系统中所能设定的最大值</span><br></pre></td></tr></table></figure>



<p>max number of threads [2048] for user [tongtech] is too low, increase to at least [4096]</p>
<p>用户的最大线程数[2048]过低，增加到至少[4096]</p>
<p><strong>vim &#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;90-nproc.conf</strong> </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>soft nproc 4096</span><br></pre></td></tr></table></figure>



<p><strong>启动：</strong></p>
<p>su taibai </p>
<p>cd &#x2F;opt&#x2F;elasticsearch-7.3.2&#x2F;bin</p>
<p>.&#x2F;elasticsearch 或  .&#x2F;elasticsearch -d   (以后台方式运行)</p>
<p>注意：注意开放端口或者关闭防火墙（centos7）</p>
<ol>
<li><p>查询防火墙状态：firewall-cmd –state</p>
</li>
<li><p>关闭防火墙：systemctl stop firewalld.service</p>
</li>
<li><p>开启防火墙： systemctl start firewalld.service</p>
</li>
<li><p>禁止firewall开机启动：systemctl disable firewalld.service</p>
</li>
</ol>
<p>安装成功!</p>
<h1 id="3-elasticsearch-head-的安装"><a href="#3-elasticsearch-head-的安装" class="headerlink" title="3.elasticsearch-head 的安装"></a>3.elasticsearch-head 的安装</h1><p>google应用商店下载插件安装（需翻墙）</p>
<h1 id="4-kibana的安装"><a href="#4-kibana的安装" class="headerlink" title="4.kibana的安装"></a>4.kibana的安装</h1><p>1.下载kibana-7.3.2-linux-x86_64.tar.gz   <a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a></p>
<p>2.上传至linux系统中并解压     tar -zxvf kibana-7.3.2-linux-x86_64.tar.gz </p>
<p>3.vim  kibana-7.3.2-linux-x86_64&#x2F;config&#x2F;kibana.yml</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="symbol">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="symbol">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br></pre></td></tr></table></figure>

<p>4.cd  kibana-7.3.2-linux-x86_64&#x2F;bin</p>
<p>5,  .&#x2F;kibana –allow-root</p>
<p>6.访问kibana</p>
<h1 id="写请求原理"><a href="#写请求原理" class="headerlink" title="写请求原理"></a>写请求原理</h1><p>以下是写单个文档所需的步骤：<br>(1 ）客户端向 NODE I 发送写请求。</p>
<p>(2)检查Active的Shard数。</p>
<p>(3) NODEI 使用文档 ID 来确定文档属于分片 0，通过集群状态中的内容路由表信息获知分片 0 的主分片位于 NODE3 ，因此请求被转发到 NODE3 上。</p>
<p>( 4 ) NODE3 上的主分片执行写操作 。 如果写入成功，则它将请求并行转发到 NODE I 和<br>NODE2 的副分片上，等待返回结果 。当所有的副分片都报告成功， NODE3 将向协调节点报告<br>成功，协调节点再向客户端报告成功 。<br>在客户端收到成功响应时 ，意味着写操作已经在主分片和所有副分片都执行完成。</p>
<p><strong>1. 为什么要检查Active的Shard数？</strong></p>
<p>ES中有一个参数，叫做wait<em>for</em>activeshards，这个参数是Index的一个setting，也可以在请求中带上这个参数。这个参数的含义是，在每次写入前，该shard至少具有的active副本数。假设我们有一个Index，其每个Shard有3个Replica，加上Primary则总共有4个副本。如果配置wait<em>for</em>activeshards为3，那么允许最多有一个Replica挂掉，如果有两个Replica挂掉，则Active的副本数不足3，此时不允许写入。</p>
<p>这个参数默认是1，即只要Primary在就可以写入，起不到什么作用。如果配置大于1，可以起到一种保护的作用，保证写入的数据具有更高的可靠性。但是这个参数只在写入前检查，并不保证数据一定在至少这些个副本上写入成功，所以并不是严格保证了最少写入了多少个副本。</p>
<p><strong>在以前的版本中，是写一致性机制，现被替换为wait<em>for</em>activeshards</strong></p>
<p>one：要求我们这个写操作，只要有一个primary shard是active活跃可用的，就可以执行<br>all：要求我们这个写操作，必须所有的primary shard和replica shard都是活跃的，才可以执行这个写操作<br>quorum：要求所有的shard中，必须是大部分的shard都是活跃的，可用的，才可以执行这个写操作</p>
<p>写一致性的默认策略是 quorum，即多数的分片（其中分片副本可以是主分片或副分片）在<br>写入操作时处于可用状态。 </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">put /<span class="keyword">index</span>/<span class="keyword">type</span>/id?consistency=quorum</span><br><span class="line">quroum = <span class="type">int</span>( (<span class="keyword">primary</span> + number_of_replicas) / <span class="number">2</span> ) + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>简 介</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>设置文档版本号。主要用于实现乐观锁</td>
</tr>
<tr>
<td>version_type</td>
<td>详见版本类型</td>
</tr>
<tr>
<td>op_type</td>
<td>可设置为 create 。 代表仅在文档不存在时才写入 。 如果文档己存在，则写请求将失败</td>
</tr>
<tr>
<td>routing</td>
<td>ES 默认使用文档 ID 进行路由，指定 routing 可使用 routing 值进行路由</td>
</tr>
<tr>
<td>wait_for_active_shards</td>
<td>用于控制写一致性，当指定数量的分片副本可用时才执行写入，否则重试直至超时 。默认为 l ， 主分片可用 即执行写入</td>
</tr>
<tr>
<td>refresh</td>
<td>写入完毕后执行 refresh ，使其对搜索可见</td>
</tr>
<tr>
<td>timeout</td>
<td>请求超时时间 ， 默认为 l 分钟</td>
</tr>
<tr>
<td>pipeline</td>
<td>指定事先创建好的 pipeline 名称</td>
</tr>
</tbody></table>
<p><strong>写入Primary完成后，为何要等待所有Replica响应(或连接失败)后返回</strong></p>
<p>在更早的ES版本，Primary和Replica之间是允许异步复制的，即写入Primary成功即可返回。但是这种模式下，如果Primary挂掉，就有丢数据的风险，而且从Replica读数据也很难保证能读到最新的数据。所以后来ES就取消异步模式了，改成Primary等Replica返回后再返回给客户端。</p>
<p>因为Primary要等所有Replica返回才能返回给客户端，那么延迟就会受到最慢的Replica的影响，这确实是目前ES架构的一个弊端。之前曾误认为这里是等wait<em>for</em>active_shards个副本写入成功即可返回，但是后来读源码发现是等所有Replica返回的。</p>
<p>如果Replica写入失败，ES会执行一些重试逻辑等，但最终并不强求一定要在多少个节点写入成功。在返回的结果中，会包含数据在多少个shard中写入成功了，多少个失败了	</p>
<h1 id="5-RESTful-API"><a href="#5-RESTful-API" class="headerlink" title="5.RESTful API"></a>5.RESTful API</h1><h4 id="1-创建空索引"><a href="#1-创建空索引" class="headerlink" title="1.创建空索引"></a>1.创建空索引</h4><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="operator">/</span><span class="keyword">taibai</span> </span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;settings&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">		<span class="string">&quot;number_of_shards&quot;</span><span class="operator">:</span> <span class="string">&quot;2&quot;</span>,   <span class="comment">//分片数</span></span><br><span class="line">		<span class="string">&quot;number_of_replicas&quot;</span><span class="operator">:</span> <span class="string">&quot;0&quot;</span>,  <span class="comment">//副本数</span></span><br><span class="line">		<span class="string">&quot;write.wait_for_active_shards&quot;</span><span class="operator">:</span> 1</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改副本数</span><br><span class="line">PUT taibai<span class="operator">/</span><span class="keyword">_settings</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span> <span class="operator">:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-删除索引"><a href="#2-删除索引" class="headerlink" title="2.删除索引"></a>2.删除索引</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /taibai</span><br></pre></td></tr></table></figure>

<h4 id="3-插入数据"><a href="#3-插入数据" class="headerlink" title="3.插入数据"></a>3.插入数据</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定id</span></span><br><span class="line">POST <span class="keyword">/taibai/</span>_doc/<span class="number">1001</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;id&quot;</span>:<span class="number">1001</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="number">20</span>,</span><br><span class="line">  <span class="string">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//不指定id  es帮我们自动生成</span></span><br><span class="line">POST <span class="keyword">/taibai/</span><span class="title class_">_doc</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;id&quot;</span>:<span class="number">1002</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;三哥&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="number">20</span>,</span><br><span class="line">  <span class="string">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="4-更新数据"><a href="#4-更新数据" class="headerlink" title="4.更新数据"></a>4.更新数据</h4><p>在Elasticsearch中，文档数据是不为修改的，但是可以通过覆盖的方式进行更新 </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="regexp">/taibai/</span>_doc/<span class="number">1001</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>:<span class="number">1009</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>:<span class="string">&quot;太白&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="number">21</span>,</span><br><span class="line">  <span class="string">&quot;sex&quot;</span>:<span class="string">&quot;哈哈&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1局部更新："><a href="#4-1局部更新：" class="headerlink" title="4.1局部更新："></a>4.1局部更新：</h4><p>其实es内部对partial update的实际执行和传统的全量替换方式是几乎一样的，其步骤如下</p>
<ol>
<li>内部先获取到对应的document；</li>
<li>将传递过来的field更新到document的json中(这一步实质上也是一样的);</li>
<li>将老的document标记为deleted（到一定时候才会物理删除）;</li>
<li>将修改后的新的document创建出来</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="regexp">/taibai/</span>_update/<span class="number">1001</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">     <span class="string">&quot;age&quot;</span>:<span class="number">23</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换和更新的不同：替换是每次都会去替换，更新是有新的东西就更新，没有新的修改就不更新，更新比替换的性能好</p>
<h4 id="5-删除数据"><a href="#5-删除数据" class="headerlink" title="5.删除数据"></a>5.删除数据</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="regexp">/taibai/</span>_doc/<span class="number">1001</span></span><br></pre></td></tr></table></figure>

<h4 id="6-0根据id搜索数据"><a href="#6-0根据id搜索数据" class="headerlink" title="6.0根据id搜索数据"></a>6.0根据id搜索数据</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /taibai/_doc/6_h43W0BdTjVHQ-cgnv2</span><br></pre></td></tr></table></figure>

<h4 id="6-1搜索全部数据"><a href="#6-1搜索全部数据" class="headerlink" title="6.1搜索全部数据"></a>6.1搜索全部数据</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="regexp">/taibai/</span>_search    默认最多返回<span class="number">10</span>条数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST <span class="regexp">/bank/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_all&quot;</span>: &#123;&#125; &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;属性名&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">took      	 Elasticsearch运行查询需要多长时间(以毫秒为单位)</span><br><span class="line">timed_out  	 搜索请求是否超时</span><br><span class="line">_shards      搜索了多少碎片，并对多少碎片成功、失败或跳过进行了细分。</span><br><span class="line">max_score    找到最相关的文档的得分</span><br><span class="line">hits.total.value  找到了多少匹配的文档</span><br><span class="line">hits.<span class="keyword">sort</span>    文档的排序位置(当不根据相关性得分排序时)</span><br><span class="line">hits._score  文档的相关性评分(在使用match_all时不适用)</span><br></pre></td></tr></table></figure>

<h4 id="6-2关键字搜索数据"><a href="#6-2关键字搜索数据" class="headerlink" title="6.2关键字搜索数据"></a>6.2关键字搜索数据</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /taibai/_search?<span class="attribute">q</span>=age:23    查询年龄等于23的</span><br></pre></td></tr></table></figure>

<h4 id="6-3DSL搜索"><a href="#6-3DSL搜索" class="headerlink" title="6.3DSL搜索"></a>6.3DSL搜索</h4><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST /taibai/<span class="variable">_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span> : &#123;       <span class="comment">//查询年龄等于23的</span></span><br><span class="line">      <span class="string">&quot;age&quot;</span> : <span class="number">23</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//查询地址等于mill或者lane</span></span><br><span class="line"><span class="built_in">GET</span> /bank/<span class="variable">_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;address&quot;</span>: <span class="string">&quot;mill lane&quot;</span> &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询地址等于（mill lane）的</span></span><br><span class="line"><span class="built_in">GET</span> /bank/<span class="variable">_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_phrase&quot;</span>: &#123; <span class="string">&quot;address&quot;</span>: <span class="string">&quot;mill lane&quot;</span> &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意：match 中如果加空格，那么会被认为两个单词，包含任意一个单词将被查询到</span></span><br><span class="line"><span class="comment">//match_parase 将忽略空格，将该字符认为一个整体，会在索引中匹配包含这个整体的文档。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="regexp">/taibai/</span>_search    <span class="regexp">//</span>查询年龄大于<span class="number">20</span>  并且性别是男的</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gt&quot;</span>: <span class="number">20</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<h4 id="6-4高亮显示"><a href="#6-4高亮显示" class="headerlink" title="6.4高亮显示"></a>6.4高亮显示</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="regexp">/taibai/</span>_search   			<span class="regexp">//</span>这里会分词搜索</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-5聚合"><a href="#6-5聚合" class="headerlink" title="6.5聚合"></a>6.5聚合</h4><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.x/search-aggregations.html</a></p>
<h5 id="avg-：平均值"><a href="#avg-：平均值" class="headerlink" title="avg ：平均值"></a>avg ：平均值</h5><h5 id="max：最大值"><a href="#max：最大值" class="headerlink" title="max：最大值"></a>max：最大值</h5><h5 id="min：最小值"><a href="#min：最小值" class="headerlink" title="min：最小值"></a>min：最小值</h5><h5 id="sum：求和"><a href="#sum：求和" class="headerlink" title="sum：求和"></a>sum：求和</h5><p>例如：查询平均年龄 （如果不指定size等于0，则还会返回10条数据）</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/bank/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;taibai&quot;</span>: <span class="punctuation">&#123;</span>   <span class="comment">//自定义名字</span></span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: <span class="punctuation">&#123;</span>    <span class="comment">//什么类型</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>    <span class="comment">//那个字段</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用脚本</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/bank/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;taibai&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;script&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="string">&quot;source&quot;</span>: <span class="string">&quot;doc.age.value&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="cardinality-去重统计"><a href="#cardinality-去重统计" class="headerlink" title="cardinality : 去重统计"></a>cardinality : 去重统计</h5><p>例如：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/bank/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;taibai&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="extended-stats扩展统计聚合"><a href="#extended-stats扩展统计聚合" class="headerlink" title="extended_stats扩展统计聚合"></a>extended_stats扩展统计聚合</h5><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/bank/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;taibai&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;extended_stats&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="value-count值计数统计"><a href="#value-count值计数统计" class="headerlink" title="value_count值计数统计"></a>value_count值计数统计</h5><p>可以理解为统计个数</p>
<h5 id="terms词聚合"><a href="#terms词聚合" class="headerlink" title="terms词聚合"></a>terms词聚合</h5><p>基于某个field，该 field 内的每一个【唯一词元】为一个桶，并计算每个桶内文档个数。默认返回顺序是按照文档个数多少排序。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/bank/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;taibai&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="top-hits最高匹配权值聚合"><a href="#top-hits最高匹配权值聚合" class="headerlink" title="top_hits最高匹配权值聚合"></a>top_hits最高匹配权值聚合</h5><p>获取到每组前n条数据，相当于sql 中Top（group by 后取出前n条）。它跟踪聚合中相关性最高的文档</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/bank/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;taibai&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span>,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;count&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="string">&quot;top_hits&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="string">&quot;size&quot;</span>: <span class="number">3</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="range范围"><a href="#range范围" class="headerlink" title="range范围"></a>range范围</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_age&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;<span class="selector-tag">from</span>&quot;: <span class="number">20</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="number">30</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;<span class="selector-tag">from</span>&quot;: <span class="number">30</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="number">40</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;<span class="selector-tag">from</span>&quot;: <span class="number">40</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="number">50</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-6查询响应"><a href="#6-6查询响应" class="headerlink" title="6.6查询响应"></a>6.6查询响应</h4><p>如果使用浏览器工具去查询，返回的json没有格式化，可在后面加参数pretty，返回格式化后的数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">204.209</span>:<span class="number">9200</span><span class="regexp">/taibai/</span>_doc/_fiK3W0BdTjVHQ-c0HvY?pretty</span><br></pre></td></tr></table></figure>

<h4 id="6-7指定响应字段"><a href="#6-7指定响应字段" class="headerlink" title="6.7指定响应字段"></a>6.7指定响应字段</h4><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /taibai/_doc/<span class="number">9_</span>iK3W0BdTjVHQ-czHuE?_source<span class="built_in">=id</span><span class="built_in">,name</span>    //只返<span class="built_in">回id</span><span class="built_in">和name</span>字段</span><br></pre></td></tr></table></figure>

<h4 id="6-8去掉元数据"><a href="#6-8去掉元数据" class="headerlink" title="6.8去掉元数据"></a>6.8去掉元数据</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /taibai/_source/9_iK3W0BdTjVHQ-czHuE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">还可以去掉元数据并且返回指定字段</span><br><span class="line"><span class="built_in">GET</span> /taibai/_source/9_iK3W0BdTjVHQ-czHuE?<span class="attribute">_source</span>=id,name  </span><br></pre></td></tr></table></figure>

<h4 id="6-9判断文档是否存在"><a href="#6-9判断文档是否存在" class="headerlink" title="6.9判断文档是否存在"></a>6.9判断文档是否存在</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">HEAD</span> /taibai/_doc/<span class="number">9</span>_iK3W0BdTjVHQ-czHuE</span><br></pre></td></tr></table></figure>

<h4 id="7-批量操作"><a href="#7-批量操作" class="headerlink" title="7.批量操作"></a>7.批量操作</h4><p>语法实例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; &quot;<span class="keyword">index</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;, &quot;</span>_id<span class="string">&quot; : &quot;</span><span class="number">1</span><span class="string">&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>field1<span class="string">&quot; : &quot;</span>value1<span class="string">&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">delete</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;, &quot;</span>_id<span class="string">&quot; : &quot;</span><span class="number">2</span><span class="string">&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;, &quot;</span>_id<span class="string">&quot; : &quot;</span><span class="number">3</span><span class="string">&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>field1<span class="string">&quot; : &quot;</span>value3<span class="string">&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">update</span><span class="string">&quot; : &#123;&quot;</span>_id<span class="string">&quot; : &quot;</span><span class="number">1</span><span class="string">&quot;, &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>doc<span class="string">&quot; : &#123;&quot;</span>field2<span class="string">&quot; : &quot;</span>value2<span class="string">&quot;&#125; &#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="7-1批量查询"><a href="#7-1批量查询" class="headerlink" title="7.1批量查询"></a>7.1批量查询</h4><p>如果，某一条数据不存在，不影响整体响应，需要通过found的值进行判断是否查询到数据。 </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/taibai/</span><span class="title class_">_mget</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="string">&quot;ids&quot;</span> : [ <span class="string">&quot;8fiK3W0BdTjVHQ-cxntK&quot;</span>, <span class="string">&quot;9fiK3W0BdTjVHQ-cy3sI&quot;</span> ]</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2批量插入"><a href="#7-2批量插入" class="headerlink" title="7.2批量插入"></a>7.2批量插入</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; &quot;<span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>taibai<span class="string">&quot;, &quot;</span>_id<span class="string">&quot; : &quot;</span><span class="number">3</span><span class="string">&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>id<span class="string">&quot;:2002,&quot;</span>name<span class="string">&quot;:&quot;</span>name1<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 20,&quot;</span>sex<span class="string">&quot;: &quot;</span>男<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>taibai<span class="string">&quot;, &quot;</span>_id<span class="string">&quot; : &quot;</span><span class="number">4</span><span class="string">&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>id<span class="string">&quot;:2003,&quot;</span>name<span class="string">&quot;:&quot;</span>name1<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 20,&quot;</span>sex<span class="string">&quot;: &quot;</span>男<span class="string">&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="7-3批量删除"><a href="#7-3批量删除" class="headerlink" title="7.3批量删除"></a>7.3批量删除</h4><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">_bulk</span></span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span> <span class="operator">:</span> &#123; <span class="string">&quot;_index&quot;</span> <span class="operator">:</span> <span class="string">&quot;taibai&quot;</span>, <span class="string">&quot;_id&quot;</span> <span class="operator">:</span> <span class="string">&quot;8PiK3W0BdTjVHQ-cxHs1&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span> <span class="operator">:</span> &#123; <span class="string">&quot;_index&quot;</span> <span class="operator">:</span> <span class="string">&quot;taibai&quot;</span>, <span class="string">&quot;_id&quot;</span> <span class="operator">:</span> <span class="string">&quot;6vh43W0BdTjVHQ-cHXv8&quot;</span> &#125; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="7-4批量修改"><a href="#7-4批量修改" class="headerlink" title="7.4批量修改"></a>7.4批量修改</h4><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">_bulk</span></span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span> <span class="operator">:</span> &#123;<span class="string">&quot;_id&quot;</span> <span class="operator">:</span> <span class="string">&quot;4&quot;</span>, <span class="string">&quot;_index&quot;</span> <span class="operator">:</span> <span class="string">&quot;taibai&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> <span class="operator">:</span> &#123;<span class="string">&quot;name&quot;</span> <span class="operator">:</span> <span class="string">&quot;太白&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span> <span class="operator">:</span> &#123;<span class="string">&quot;_id&quot;</span> <span class="operator">:</span> <span class="string">&quot;3&quot;</span>, <span class="string">&quot;_index&quot;</span> <span class="operator">:</span> <span class="string">&quot;taibai&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> <span class="operator">:</span> &#123;<span class="string">&quot;name&quot;</span> <span class="operator">:</span> <span class="string">&quot;太白&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-分页查询"><a href="#8-分页查询" class="headerlink" title="8.分页查询"></a>8.分页查询</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="regexp">/taibai/</span>_search?<span class="keyword">size</span>=<span class="number">1</span>&amp;<span class="keyword">from</span>=<span class="number">2</span>     <span class="keyword">size</span>: 结果数，默认<span class="number">10</span>      <span class="keyword">from</span>: 跳过开始的结果数，默认<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h5 id="分页一"><a href="#分页一" class="headerlink" title="分页一"></a>分页一</h5><p>浅分页，它的原理很简单，就是查询前20条数据，然后截断前10条，只返回10-20的数据。这样其实白白浪费了前10条的查询</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 1000,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="分页二"><a href="#分页二" class="headerlink" title="分页二"></a>分页二</h5><p>scroll 深分页，使用scroll，每次只能获取一页的内容，然后会返回一个scroll_id。根据返回的这个scroll_id可以不断地获取下一页的内容，所以scroll并不适用于有跳页的情景</p>
<ol>
<li>scroll&#x3D;5m表示设置scroll_id保留5分钟可用。</li>
<li>使用scroll必须要将from设置为0。</li>
<li>size决定后面每次调用_search搜索返回的数量</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /bank/_search?<span class="attribute">scroll</span>=5m</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 20,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">会返回一个：</span><br><span class="line"> <span class="string">&quot;_scroll_id&quot;</span> : <span class="string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAB9AWTVIyY1pKcmhUT0dBT1FXLU5ueHdDQQ==&quot;</span></span><br><span class="line"> </span><br><span class="line"> 以后调用：</span><br><span class="line"><span class="built_in">GET</span> _search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;scroll_id&quot;</span>: <span class="string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAABMIWTVIyY1pKcmhUT0dBT1FXLU5ueHdDQQ==&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scroll&quot;</span>: <span class="string">&quot;5m&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">删除scroll_id</span><br><span class="line">DELETE _search/scroll/<span class="attribute">DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAABMIWTVIyY1pKcmhUT0dBT1FXLU5ueHdDQQ</span>==</span><br><span class="line"></span><br><span class="line">删除所有scroll_id</span><br><span class="line">DELETE _search/scroll/_all</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意:根据官方文档的说法，scroll是非常消耗资源的，所以一个建议就是当不需要了scroll数据的时候，尽可能快的把scroll_id显式删除掉。scroll 的方式，官方的建议不用于实时的请求（一般用于数据导出），因为每一个 scroll_id 不仅会占用大量的资源，而且会生成历史快照，对于数据的变更不会反映到快照上。</span><br></pre></td></tr></table></figure>

<h5 id="分页三"><a href="#分页三" class="headerlink" title="分页三"></a>分页三</h5><p>search_after 深分页，是根据上一页的最后一条数据来确定下一页的位置，同时在分页请求的过程中，如果有索引数据的增删改查，这些变更也会实时的反映到游标上。但是需要注意，因为每一页的数据依赖于上一页最后一条数据，所以无法跳页请求。为了找到每一页最后一条数据，每个文档必须有一个全局唯一值，官方推荐使用 _uid 作为全局唯一值，其实使用业务层的 id 也可以。使用search_after必须要设置from&#x3D;0。</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /bank/<span class="variable">_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">拿到返回最后一条数据的<span class="variable">_id</span></span><br><span class="line"><span class="built_in">GET</span> /bank/<span class="variable">_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;search_after&quot;</span>: [</span><br><span class="line">    <span class="number">980</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="9-映射"><a href="#9-映射" class="headerlink" title="9.映射"></a>9.映射</h4><p>前面我们创建的索引以及插入数据，都是由Elasticsearch进行自动判断类型，有些时候我们是需要进行明确字段类型的，否则，自动判断的类型和实际需求是不相符的。</p>
<p>自动判断的规则如下：</p>
<table>
<thead>
<tr>
<th>JSON type</th>
<th>Field type</th>
</tr>
</thead>
<tbody><tr>
<td>Boolean: true or false</td>
<td>“boolean”</td>
</tr>
<tr>
<td>Whole number: 123</td>
<td>“long”</td>
</tr>
<tr>
<td>Floating point: 123.45</td>
<td>“double”</td>
</tr>
<tr>
<td>String, valid date: “2014-09-15”</td>
<td>“date”</td>
</tr>
<tr>
<td>String: “foo bar”</td>
<td>“string”</td>
</tr>
</tbody></table>
<p>创建明确类型的索引： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">PUT /goods</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span>: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;sn&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;num&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;alert_num&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;image&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;images&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;weight&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;create_time&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;update_time&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;spu_id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;category_id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;category_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;brand_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;spec&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;sale_num&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;comment_num&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;status&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加一个字段到现有的映射</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="operator">/</span>luban<span class="operator">/</span><span class="keyword">_mapping</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">    <span class="string">&quot;isold&quot;</span><span class="operator">:</span> &#123;      <span class="comment">//字段名</span></span><br><span class="line">      <span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;keyword&quot;</span>,  <span class="comment">//类型</span></span><br><span class="line">      <span class="string">&quot;index&quot;</span><span class="operator">:</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新字段的映射</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">除了支持的映射参数外，您不能更改现有字段的映射或字段类型。更改现有字段可能会使已经建立索引的数据无效。</span><br><span class="line"></span><br><span class="line">如果您需要更改字段映射，创建具有正确映射一个新的索引和重新索引的数据转换成指数。</span><br><span class="line"></span><br><span class="line">重命名字段会使在旧字段名称下已建立索引的数据无效。而是添加一个<span class="built_in">alias</span>字段以创建备用字段名称。</span><br></pre></td></tr></table></figure>

<p>查看索引的映射</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /luban/_mapping</span><br></pre></td></tr></table></figure>

<p>查看指定字段的映射信息</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> /luban/<span class="variable">_mapping</span>/field/<span class="built_in">name</span></span><br></pre></td></tr></table></figure>

<h4 id="10-结构化查询"><a href="#10-结构化查询" class="headerlink" title="10.结构化查询"></a>10.结构化查询</h4><h5 id="10-1term查询"><a href="#10-1term查询" class="headerlink" title="10.1term查询"></a>10.1term查询</h5><p>term 主要用于精确匹配哪些值，比如数字，日期，布尔值或 not_analyzed 的字符串(未经分析的文本数据类型)： </p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /taibai/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span> : 20</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="10-2terms查询"><a href="#10-2terms查询" class="headerlink" title="10.2terms查询"></a>10.2terms查询</h5><p>terms 跟 term 有点类似，但 terms 允许指定多个匹配条件。 如果某个字段指定了多个值，那么文档需要一起去<br>做匹配： </p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /taibai/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span> : [20,27]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="10-3range查询"><a href="#10-3range查询" class="headerlink" title="10.3range查询"></a>10.3range查询</h5><p>range 过滤允许我们按照指定范围查找一批数据： </p>
<p>gt :: 大于<br>gte :: 大于等于<br>lt :: 小于<br>lte :: 小于等于 </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/taibai/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;query&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;range&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;age&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: <span class="number">22</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="10-4exists查询"><a href="#10-4exists查询" class="headerlink" title="10.4exists查询"></a>10.4exists查询</h5><p>exists 查询可以用于查找文档中是否包含指定字段或没有某个字段，类似于SQL语句中的 IS_NULL 条件 </p>
<p>包含这个字段就返回返回这条数据</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/taibai/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;query&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;exists&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;field&quot;</span>: <span class="string">&quot;name&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="10-5-match查询"><a href="#10-5-match查询" class="headerlink" title="10.5 match查询"></a>10.5 match查询</h5><p>match 查询是一个标准查询，不管你需要全文本查询还是精确查询基本上都要用到它。<br>如果你使用 match 查询一个全文本字段，它会在真正查询之前用分析器先分析 match 一下查询字符；如果用 match 下指定了一个确切值，在遇到数字，日期，布尔值或者 not_analyzed 的字符串时，它将为你搜索你<br>给定的值： </p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /taibai/_<span class="built_in">search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span> <span class="symbol">:</span> &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span> <span class="symbol">:</span> &#123;     </span><br><span class="line">      <span class="string">&quot;name&quot;</span> <span class="symbol">:</span> <span class="string">&quot;三个小矮人&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">match</span>查询会先对搜索词进行分词,分词完毕后再逐个对分词结果进行匹配，因此相比于term的精确搜索，<span class="built_in">match</span>是分词匹配搜索</span><br></pre></td></tr></table></figure>

<h5 id="10-6-bool查询"><a href="#10-6-bool查询" class="headerlink" title="10.6  bool查询"></a>10.6  bool查询</h5><p>bool 查询可以用来合并多个条件查询结果的布尔逻辑，它包含一下操作符：<br>must :: 多个查询条件的完全匹配,相当于 and 。<br>must_not :: 多个查询条件的相反匹配，相当于 not 。<br>should :: 至少有一个查询条件匹配, 相当于 or 。<br>这些参数可以分别继承一个查询条件或者一个查询条件的数组： </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/taibai/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="string">&quot;query&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="string">&quot;must&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="string">&quot;term&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span>,</span><br><span class="line">			<span class="string">&quot;must_not&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="string">&quot;term&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="string">&quot;age&quot;</span>: <span class="string">&quot;29&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span>,</span><br><span class="line">			<span class="string">&quot;should&quot;</span>: [</span><br><span class="line">			  <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="string">&quot;term&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span>,</span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="string">&quot;term&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="string">&quot;id&quot;</span>: <span class="number">1003</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			]</span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="10-7过滤查询"><a href="#10-7过滤查询" class="headerlink" title="10.7过滤查询"></a>10.7过滤查询</h5><p>查询年龄为20岁的用户。 </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="keyword">/taibai/</span><span class="title class_">_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="string">&quot;query&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="string">&quot;filter&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="string">&quot;term&quot;</span>: <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="string">&quot;age&quot;</span>: <span class="number">20</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="批量导入测试数据"><a href="#批量导入测试数据" class="headerlink" title="批量导入测试数据"></a>批量导入测试数据</h4><p>该数据是使用<a target="_blank" rel="noopener" href="http://www.json-/">www.json-</a> <a href="https://link.zhihu.com/?target=http://generator.com/">http://generator.com/</a>生成的，因此请忽略数据的实际值和语义，因为它们都是随机生成的。您可以从这里下载示例数据集（accounts.json）。将其提取到当前目录，然后按如下方式将其加载到集群中：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span> -XPOST <span class="string">&quot;localhost:9200/bank/_bulk?pretty&amp;refresh&quot;</span> --data-binary <span class="string">&quot;<span class="variable">@accounts</span>.json&quot;</span></span><br></pre></td></tr></table></figure>

<p>官方文档练习案例：</p>
<p>1.给指定id加点年龄(age)</p>
<p>2.执行<code>match_all</code>操作，并按帐户余额降序对结果进行排序，并返回前10个</p>
<p>3.如何从搜索中返回两个字段，即帐号和余额</p>
<p>4.返回帐户为20的</p>
<p>5.返回地址中包含“mill”的所有帐户</p>
<p>6.返回地址中包含“mill”或“lane”的所有帐户</p>
<p>7.返回地址中包含“mill”和“lane”的所有帐户</p>
<p>8.地址中既不包含“mill”也不包含“lane”的所有帐户</p>
<p>9.返回所有40岁但不居住在ID的人(state不等于ID)的账户</p>
<p>10.使用bool查询返回余额在20000到30000之间的所有帐户，包括余额。换句话说，我们希望找到余额大于或等于20000，小于或等于30000的账户</p>
<p>11.按状态(state)对所有帐户进行分组，然后返回按count降序排列的前10个</p>
<p>12.按状态计算平均帐户余额(同样只针对按count降序排列的前10个状态)</p>
<p>13.基于之前(12)的聚合，我们现在按降序对平均余额排序</p>
<p>14.按照年龄等级(20-29岁，30-39岁，40-49岁)分组，然后按性别分组，最后得到每个年龄等级，每个性别的平均账户余额</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST /bank/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;script&quot;</span>: <span class="string">&quot;ctx._source.age+=5&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;balance&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;account_number&quot;</span>,<span class="string">&quot;balance&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;account_number&quot;</span>: <span class="string">&quot;20&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: <span class="string">&quot;mill&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: <span class="string">&quot;mill lane&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;mill&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;lane&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;mill&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;lane&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;value&quot;</span>: 40</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;state&quot;</span>: <span class="string">&quot;ID&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;balance&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 20000,</span><br><span class="line">              <span class="string">&quot;lte&quot;</span>: 30000</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;status_group&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;state.keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;status_group&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;state.keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;balance_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;status_group&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;state.keyword&quot;</span>,</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;balance_avg&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;balance_avg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 20,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 30</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 30,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 40</span><br><span class="line">          &#125;,&#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 40,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 50</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gender_group&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;balance_avg&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="6-中文分词"><a href="#6-中文分词" class="headerlink" title="6.中文分词"></a>6.中文分词</h1><h5 id="6-0-Analyzer-的组成"><a href="#6-0-Analyzer-的组成" class="headerlink" title="6.0 Analyzer 的组成"></a>6.0 <strong>Analyzer 的组成</strong></h5><ul>
<li>Character Filters (针对原始文本处理，例如，可以使用字符过滤器将印度阿拉伯数字（ ）转换为其等效的阿拉伯语-拉丁语（0123456789）)</li>
<li>Tokenizer（按照规则切分为单词）,将把文本 “Quick brown fox!” 转换成 terms [Quick, brown, fox!],tokenizer 还记录文本单词位置以及偏移量。</li>
<li>Token Filter(将切分的的单词进行加工、小写、刪除 stopwords，增加同义词）</li>
</ul>
<h5 id="6-1elasticsearch内置分词器"><a href="#6-1elasticsearch内置分词器" class="headerlink" title="6.1elasticsearch内置分词器"></a>6.1elasticsearch内置分词器</h5><table>
<thead>
<tr>
<th align="left"><strong>Standard</strong></th>
<th>默认分词器  按词分类  小写处理</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Simple</strong></td>
<td>按照非字母切分，非字母则会被去除  小写处理</td>
</tr>
<tr>
<td align="left">**Stop **</td>
<td>小写处理  停用词过滤（the，a, is)</td>
</tr>
<tr>
<td align="left">**Whitespace **</td>
<td>按空格切分</td>
</tr>
<tr>
<td align="left">**Keyword **</td>
<td>不分词，当成一整个 term 输出</td>
</tr>
<tr>
<td align="left">**Patter **</td>
<td>通过正则表达式进行分词  默认是 \W+(非字母进行分隔)</td>
</tr>
<tr>
<td align="left">**Language **</td>
<td>提供了 30 多种常见语言的分词器</td>
</tr>
</tbody></table>
<h5 id="6-2分词api"><a href="#6-2分词api" class="headerlink" title="6.2分词api"></a><strong>6.2分词api</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;tai bai&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:<span class="string">&quot;决战到天亮&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 英文分词  一般以空格分隔，中文分词的难点在于，在汉语中没有明显的词汇分界点，如果分隔不正确就会造成歧义。 </p>
<p>常用中文分词器，IK、jieba、THULAC等，推荐使用IK分词器。 </p>
<h5 id="6-3ik分词器安装"><a href="#6-3ik分词器安装" class="headerlink" title="6.3ik分词器安装"></a><strong>6.3ik分词器安装</strong></h5><p>IK分词器 Elasticsearch插件地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a> </p>
<p><strong>注意选择对应es的版本</strong></p>
<p><strong>1.下载项目  zip包</strong></p>
<p><strong>2.解压项目</strong></p>
<p><strong>3.进入项目跟目录 使用maven编译打包此项目</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mvn</span> clean</span><br><span class="line"><span class="keyword">mvn</span> compile</span><br><span class="line"><span class="keyword">mvn</span> package</span><br></pre></td></tr></table></figure>

<p><strong>4.执行完上面命令后 在{project_path}&#x2F;elasticsearch-analysis-ik&#x2F;target&#x2F;releases&#x2F;elasticsearch-analysis-ik-*.zip会有个zip,上传到linux   elasticsearch 插件目录, 如: plugins&#x2F;ik   注意在plugins下新建ik目录  将zip包上传到ik目录下</strong></p>
<p><strong>5.使用unzip命令解压zip包，没有unzip的  可先下载unzip   命令：yum install -y unzip zip</strong></p>
<p><strong>6.解压之后删除原来的zip包</strong></p>
<p><strong>7.检查是否需要修改版本信息</strong></p>
<p><strong>vim   {path}&#x2F;plugins&#x2F;ik&#x2F;plugin-descriptor.properties</strong></p>
<p><strong>8.重启 ik插件安装完成</strong></p>
<p><strong>9.测试中文分词器效果</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,   或者  //ik_smart</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;决战到天亮&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="6-4拼音分词器"><a href="#6-4拼音分词器" class="headerlink" title="6.4拼音分词器"></a><strong>6.4拼音分词器</strong></h5><p><strong>1.下载对应版本的zip包<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin/releases">https://github.com/medcl/elasticsearch-analysis-pinyin/releases</a></strong></p>
<p><strong>2.可在Windows解压好，在plugins下创建pinyin文件夹</strong></p>
<p><strong>3.将解压内容放置在pinyin文件夹，重启</strong></p>
<h5 id="6-5自定义分词器"><a href="#6-5自定义分词器" class="headerlink" title="6.5自定义分词器"></a>6.5自定义分词器</h5><p><strong>接受参数</strong></p>
<table>
<thead>
<tr>
<th>tokenizer</th>
<th>一个内置的或定制的tokenizer。(必需)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>char_filter</strong></td>
<td><strong>一个可选的内置或自定义字符过滤器数组。</strong></td>
</tr>
<tr>
<td><strong>filter</strong></td>
<td><strong>一个可选的内置或定制token过滤器数组。</strong></td>
</tr>
</tbody></table>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="keyword">my_index</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">        <span class="string">&quot;my_custom_analyzer&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;custom&quot;</span>, </span><br><span class="line">          <span class="string">&quot;tokenizer&quot;</span><span class="operator">:</span> <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">          <span class="string">&quot;char_filter&quot;</span><span class="operator">:</span> [</span><br><span class="line">            <span class="string">&quot;html_strip&quot;</span>     <span class="comment">//过滤HTML标签</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;filter&quot;</span><span class="operator">:</span> [</span><br><span class="line">            <span class="string">&quot;lowercase&quot;</span>,    <span class="comment">//转小写</span></span><br><span class="line">            <span class="string">&quot;asciifolding&quot;</span>  <span class="comment">//ASCII-折叠令牌过滤器  例如 à to a</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST my_index<span class="operator">/</span><span class="keyword">_analyze</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span><span class="operator">:</span> <span class="string">&quot;my_custom_analyzer&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span><span class="operator">:</span> <span class="string">&quot;Is this &lt;b&gt;déjà vu&lt;/b&gt;?&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>创建一个中文+拼音的分词器</strong>（中文分词后拼音分词）</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ik_pinyin_analyzer&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tokenizer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;pinyin_max_word_filter&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ik_pingying_smark&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tokenizer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;pinyin_smark_word_filter&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;pinyin_max_word_filter&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pinyin&quot;</span>,</span><br><span class="line">          <span class="string">&quot;keep_full_pinyin&quot;</span>: <span class="string">&quot;true&quot;</span>,  <span class="comment">#分词全拼如雪花 分词xue,hua</span></span><br><span class="line">          <span class="string">&quot;keep_separate_first_letter&quot;</span>: <span class="string">&quot;true&quot;</span>,<span class="comment">#分词简写如雪花 分词xh</span></span><br><span class="line">          <span class="string">&quot;keep_joined_full_pinyin&quot;</span>: <span class="literal">true</span>  <span class="comment">#分词会quanpin 连接 比如雪花分词 xuehua</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;pinyin_smark_word_filter&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pinyin&quot;</span>,</span><br><span class="line">          <span class="string">&quot;keep_separate_first_letter&quot;</span>: <span class="string">&quot;false&quot;</span>, <span class="comment">#不分词简写如雪花 分词不分词xh</span></span><br><span class="line">          <span class="string">&quot;keep_first_letter&quot;</span>: <span class="string">&quot;false&quot;</span>     <span class="comment">#不分词单个首字母 如雪花 不分词 x,h</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT <span class="string">/my_index/_mapping</span></span><br><span class="line">  &#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;productName&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_pinyin_analyzer&quot;</span>,  <span class="comment">#做文档所用的分词器</span></span><br><span class="line">          <span class="string">&quot;search_analyzer&quot;</span>:<span class="string">&quot;ik_pingying_smark&quot;</span>   <span class="comment">#搜索使用的分词器</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST <span class="string">/my_index/_doc</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;productName&quot;</span>: <span class="string">&quot;雪花啤酒100L&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET <span class="string">/my_index/_search</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;productName&quot;</span>: <span class="string">&quot;雪Hua&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="7-全文搜索"><a href="#7-全文搜索" class="headerlink" title="7.全文搜索"></a><strong>7.全文搜索</strong></h1><h5 id="7-1构建数据"><a href="#7-1构建数据" class="headerlink" title="7.1构建数据"></a><strong>7.1构建数据</strong></h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">PUT /test</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;: &#123;</span><br><span class="line">		&quot;<span class="keyword">index</span><span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">			&quot;</span>number_of_shards<span class="string">&quot;: &quot;</span><span class="number">1</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">			&quot;</span>number_of_replicas<span class="string">&quot;: &quot;</span><span class="number">0</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;</span>mappings<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">		&quot;</span>properties<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">			&quot;</span>age<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;</span><span class="built_in">type</span><span class="string">&quot;: &quot;</span>integer<span class="string">&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;</span>email<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;</span><span class="built_in">type</span><span class="string">&quot;: &quot;</span>keyword<span class="string">&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;</span>name<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;</span><span class="built_in">type</span><span class="string">&quot;: &quot;</span>text<span class="string">&quot;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			&quot;</span>hobby<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">				&quot;</span><span class="built_in">type</span><span class="string">&quot;: &quot;</span>text<span class="string">&quot;,</span></span><br><span class="line"><span class="string">				&quot;</span>analyzer<span class="string">&quot;: &quot;</span>ik_max_word<span class="string">&quot;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST _bulk</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;: &quot;</span><span class="number">1000</span><span class="string">&quot;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>张三<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 20,&quot;</span>mail<span class="string">&quot;: &quot;</span><span class="number">111</span>@qq.com<span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;:&quot;</span>羽毛球、乒乓球、足球<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;: &quot;</span><span class="number">1001</span><span class="string">&quot;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>李四<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 21,&quot;</span>mail<span class="string">&quot;: &quot;</span><span class="number">222</span>@qq.com<span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;:&quot;</span>羽毛球、乒乓球、足球、篮球<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;: &quot;</span><span class="number">1002</span><span class="string">&quot;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>王五<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 22,&quot;</span>mail<span class="string">&quot;: &quot;</span><span class="number">333</span>@qq.com<span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;:&quot;</span>羽毛球、篮球、游泳、听音乐<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;: &quot;</span><span class="number">1003</span><span class="string">&quot;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>赵六<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 23,&quot;</span>mail<span class="string">&quot;: &quot;</span><span class="number">444</span>@qq.com<span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;:&quot;</span>跑步、游泳、篮球<span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">create</span><span class="string">&quot; : &#123; &quot;</span>_index<span class="string">&quot; : &quot;</span>test<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;: &quot;</span><span class="number">1004</span><span class="string">&quot;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>孙七<span class="string">&quot;,&quot;</span>age<span class="string">&quot;: 24,&quot;</span>mail<span class="string">&quot;: &quot;</span><span class="number">555</span>@qq.com<span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;:&quot;</span>听音乐、看电影、羽毛球<span class="string">&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="7-2单词搜索"><a href="#7-2单词搜索" class="headerlink" title="7.2单词搜索"></a><strong>7.2单词搜索</strong></h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;音乐&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-3多词搜索"><a href="#7-3多词搜索" class="headerlink" title="7.3多词搜索"></a><strong>7.3多词搜索</strong></h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//搜索包含音乐和篮球的</span></span><br><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;音乐 篮球&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//搜索包含音乐还有篮球的（and）</span></span><br><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;query&quot;</span>: <span class="string">&quot;音乐 篮球&quot;</span>,</span><br><span class="line">				<span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 1000,</span><br><span class="line">              <span class="string">&quot;lte&quot;</span>: 2000</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;2018女鞋&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;spec&quot;</span>: <span class="string">&quot;红色 黑色&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;spec&quot;</span>: <span class="string">&quot;蓝色&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在Elasticsearch中也支持这样的查询，通过minimum_should_match来指定匹配度，如：70%；</span></span><br><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;query&quot;</span>: <span class="string">&quot;游泳 羽毛球&quot;</span>,</span><br><span class="line">				<span class="string">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;70%&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-4组合搜索"><a href="#7-4组合搜索" class="headerlink" title="7.4组合搜索"></a><strong>7.4组合搜索</strong></h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//搜索结果中必须包含篮球，不能包含音乐，如果包含了游泳，那么它的相似度更高。</span></span><br><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;篮球&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;must_not&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;音乐&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;should&quot;</span>: [&#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;游泳&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//默认情况下，should中的内容不是必须匹配的，如果查询语句中没有must，那么就会至少匹配其中一个。当然了，</span></span><br><span class="line">也可以通过minimum_should_match参数进行控制，该值可以是数字也可以的百分比。</span><br><span class="line"><span class="comment">//minimum_should_match为2，意思是should中的三个词，至少要满足2个</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;should&quot;</span>: [&#123;</span><br><span class="line">					<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;游泳&quot;</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;篮球&quot;</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;hobby&quot;</span>: <span class="string">&quot;音乐&quot;</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			],</span><br><span class="line">			<span class="string">&quot;minimum_should_match&quot;</span>: 2</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-5权重"><a href="#7-5权重" class="headerlink" title="7.5权重"></a><strong>7.5权重</strong></h5><p>搜索关键字为“游泳篮球”，如果结果中包含了“音乐”权重为10，包含了“跑步”权重为2。 </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> /<span class="keyword">test</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;hobby&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;query&quot;</span>: <span class="string">&quot;游泳篮球&quot;</span>,</span><br><span class="line">						<span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;should&quot;</span>: [&#123;</span><br><span class="line">					<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;hobby&quot;</span>: &#123;</span><br><span class="line">							<span class="string">&quot;query&quot;</span>: <span class="string">&quot;音乐&quot;</span>,</span><br><span class="line">							<span class="string">&quot;boost&quot;</span>: 10</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;hobby&quot;</span>: &#123;</span><br><span class="line">							<span class="string">&quot;query&quot;</span>: <span class="string">&quot;跑步&quot;</span>,</span><br><span class="line">							<span class="string">&quot;boost&quot;</span>: 2</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;hobby&quot;</span>: &#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-Elasticsearch集群"><a href="#8-Elasticsearch集群" class="headerlink" title="8.Elasticsearch集群"></a><strong>8.Elasticsearch集群</strong></h1><h5 id="192-168-204-209-elasticsearch-yml"><a href="#192-168-204-209-elasticsearch-yml" class="headerlink" title="192.168.204.209  elasticsearch.yml"></a><strong>192.168.204.209  elasticsearch.yml</strong></h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cluster.<span class="params">name:</span> luban</span><br><span class="line">node.<span class="params">name:</span> node-<span class="number">1</span></span><br><span class="line">node.<span class="params">master:</span> <span class="literal">true</span></span><br><span class="line">node.<span class="params">data:</span> <span class="literal">true</span></span><br><span class="line">network.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http.<span class="params">port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#参数设置一系列符合主节点条件的节点的主机名或 IP 地址来引导启动集群。</span></span><br><span class="line">cluster.<span class="params">initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>]</span><br><span class="line"><span class="comment"># 设置新节点被启动时能够发现的主节点列表（主要用于不同网段机器连接）</span></span><br><span class="line">discovery.zen.ping.unicast.<span class="params">hosts:</span> [<span class="string">&quot;192.168.204.209&quot;</span>,<span class="string">&quot;192.168.204.203&quot;</span>,<span class="string">&quot;192.168.204.108&quot;</span>]</span><br><span class="line"><span class="comment"># 该参数就是为了防止”脑裂”的产生。定义的是为了形成一个集群，有主节点资格并互相连接的节点的最小数目。</span></span><br><span class="line">discovery.zen.<span class="params">minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># 解决跨域问题配置</span></span><br><span class="line">http.cors.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">http.cors.<span class="params">allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="192-168-204-203-elasticsearch-yml"><a href="#192-168-204-203-elasticsearch-yml" class="headerlink" title="192.168.204.203  elasticsearch.yml"></a><strong>192.168.204.203  elasticsearch.yml</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cluster<span class="selector-class">.name</span>: luban</span><br><span class="line">node<span class="selector-class">.name</span>: node-<span class="number">3</span></span><br><span class="line">node<span class="selector-class">.master</span>: true</span><br><span class="line">node<span class="selector-class">.data</span>: true</span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http<span class="selector-class">.port</span>: <span class="number">9200</span></span><br><span class="line">cluster<span class="selector-class">.initial_master_nodes</span>: <span class="selector-attr">[<span class="string">&quot;node-1&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.ping</span><span class="selector-class">.unicast</span><span class="selector-class">.hosts</span>: <span class="selector-attr">[<span class="string">&quot;192.168.204.209&quot;</span>,<span class="string">&quot;192.168.204.203&quot;</span>,<span class="string">&quot;192.168.204.108&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span>: <span class="number">2</span></span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.enabled</span>: true</span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.allow-origin</span>: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="192-168-204-108-elasticsearch-yml"><a href="#192-168-204-108-elasticsearch-yml" class="headerlink" title="192.168.204.108  elasticsearch.yml"></a><strong>192.168.204.108  elasticsearch.yml</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cluster<span class="selector-class">.name</span>: luban</span><br><span class="line">node<span class="selector-class">.name</span>: node-<span class="number">2</span></span><br><span class="line">node<span class="selector-class">.master</span>: true</span><br><span class="line">node<span class="selector-class">.data</span>: true</span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http<span class="selector-class">.port</span>: <span class="number">9200</span></span><br><span class="line">cluster<span class="selector-class">.initial_master_nodes</span>: <span class="selector-attr">[<span class="string">&quot;node-1&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.ping</span><span class="selector-class">.unicast</span><span class="selector-class">.hosts</span>: <span class="selector-attr">[<span class="string">&quot;192.168.204.209&quot;</span>,<span class="string">&quot;192.168.204.203&quot;</span>,<span class="string">&quot;192.168.204.108&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span>: <span class="number">2</span></span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.enabled</span>: true</span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.allow-origin</span>: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>启动后效果</strong></p>
<h3 id="一台机器搭建集群-一"><a href="#一台机器搭建集群-一" class="headerlink" title="一台机器搭建集群(一)"></a><strong>一台机器搭建集群(一)</strong></h3><p><strong>注意修改jvm.options</strong></p>
<h5 id="elasticsearch-7-3-2-node1"><a href="#elasticsearch-7-3-2-node1" class="headerlink" title="elasticsearch-7.3.2_node1"></a><strong>elasticsearch-7.3.2_node1</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster<span class="selector-class">.name</span>: luban</span><br><span class="line">node<span class="selector-class">.name</span>: node-<span class="number">1</span></span><br><span class="line">node<span class="selector-class">.master</span>: true</span><br><span class="line">node<span class="selector-class">.data</span>: true</span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http<span class="selector-class">.port</span>: <span class="number">9200</span></span><br><span class="line">transport<span class="selector-class">.port</span>: <span class="number">9300</span></span><br><span class="line">cluster<span class="selector-class">.initial_master_nodes</span>: <span class="selector-attr">[<span class="string">&quot;node-1&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.seed_hosts</span>: <span class="selector-attr">[<span class="string">&quot;192.168.204.209:9300&quot;</span>, <span class="string">&quot;192.168.204.209:9301&quot;</span>,<span class="string">&quot;192.168.204.209:9302&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span>: <span class="number">2</span></span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.enabled</span>: true</span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.allow-origin</span>: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="elasticsearch-7-3-2-node2"><a href="#elasticsearch-7-3-2-node2" class="headerlink" title="elasticsearch-7.3.2_node2"></a><strong>elasticsearch-7.3.2_node2</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster<span class="selector-class">.name</span>: luban</span><br><span class="line">node<span class="selector-class">.name</span>: node-<span class="number">2</span></span><br><span class="line">node<span class="selector-class">.master</span>: true</span><br><span class="line">node<span class="selector-class">.data</span>: true</span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http<span class="selector-class">.port</span>: <span class="number">9201</span></span><br><span class="line">transport<span class="selector-class">.port</span>: <span class="number">9301</span></span><br><span class="line">cluster<span class="selector-class">.initial_master_nodes</span>: <span class="selector-attr">[<span class="string">&quot;node-1&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.seed_hosts</span>: <span class="selector-attr">[<span class="string">&quot;192.168.204.209:9300&quot;</span>, <span class="string">&quot;192.168.204.209:9301&quot;</span>,<span class="string">&quot;192.168.204.209:9302&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span>: <span class="number">2</span></span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.enabled</span>: true</span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.allow-origin</span>: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="elasticsearch-7-3-2-node3"><a href="#elasticsearch-7-3-2-node3" class="headerlink" title="elasticsearch-7.3.2_node3"></a><strong>elasticsearch-7.3.2_node3</strong></h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster<span class="selector-class">.name</span>: luban</span><br><span class="line">node<span class="selector-class">.name</span>: node-<span class="number">3</span></span><br><span class="line">node<span class="selector-class">.master</span>: true</span><br><span class="line">node<span class="selector-class">.data</span>: true</span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http<span class="selector-class">.port</span>: <span class="number">9202</span></span><br><span class="line">transport<span class="selector-class">.port</span>: <span class="number">9302</span></span><br><span class="line">cluster<span class="selector-class">.initial_master_nodes</span>: <span class="selector-attr">[<span class="string">&quot;node-1&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.seed_hosts</span>: <span class="selector-attr">[<span class="string">&quot;192.168.204.209:9300&quot;</span>, <span class="string">&quot;192.168.204.209:9301&quot;</span>,<span class="string">&quot;192.168.204.209:9302&quot;</span>]</span></span><br><span class="line">discovery<span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span>: <span class="number">2</span></span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.enabled</span>: true</span><br><span class="line">http<span class="selector-class">.cors</span><span class="selector-class">.allow-origin</span>: <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>分别启动：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch -p /tmp/elasticsearch_9200_pid -d</span><br><span class="line">./elasticsearch -p /tmp/elasticsearch_9201_pid -d</span><br><span class="line">./elasticsearch -p /tmp/elasticsearch_9202_pid -d</span><br></pre></td></tr></table></figure>

<h3 id="一台机器搭建集群-二"><a href="#一台机器搭建集群-二" class="headerlink" title="一台机器搭建集群(二)"></a><strong>一台机器搭建集群(二)</strong></h3><p><strong>新建目录：</strong></p>
<p><strong>注意赋予权限</strong></p>
<p><strong>chown -R taibai:taibai ES</strong></p>
<p><strong>分别启动：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch -d  -E node.<span class="attribute">name</span>=node-1 -E http.<span class="attribute">port</span>=9200 -E transport.<span class="attribute">port</span>=9300 -E path.<span class="attribute">data</span>=/ES/data/node1 -E path.<span class="attribute">logs</span>=/ES/logs/node1</span><br><span class="line"></span><br><span class="line">./elasticsearch -d  -E node.<span class="attribute">name</span>=node-2 -E http.<span class="attribute">port</span>=9201 -E transport.<span class="attribute">port</span>=9301 -E path.<span class="attribute">data</span>=/ES/data/node2 -E path.<span class="attribute">logs</span>=/ES/logs/node2</span><br><span class="line"></span><br><span class="line">./elasticsearch -d  -E node.<span class="attribute">name</span>=node-3 -E http.<span class="attribute">port</span>=9202 -E transport.<span class="attribute">port</span>=9302 -E path.<span class="attribute">data</span>=/ES/data/node3 -E path.<span class="attribute">logs</span>=/ES/logs/node3</span><br></pre></td></tr></table></figure>

<p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/jiankunking/article/details/65448030">https://blog.csdn.net/jiankunking/article/details/65448030</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/lixiaohai_918/article/details/89569611">https://blog.csdn.net/lixiaohai_918/article/details/89569611</a></strong></p>
<p><strong>查看插件命令：.&#x2F;elasticsearch-plugin list</strong></p>
<p><strong>下载插件命令：.&#x2F;elasticsearch-plugin install analysis-icu</strong></p>
<hr>
<h1 id="二、pdf版"><a href="#二、pdf版" class="headerlink" title="二、pdf版"></a>二、pdf版</h1><p>【腾讯文档】ES课件完整版<br><a target="_blank" rel="noopener" href="https://docs.qq.com/pdf/DTm5rb2Z3UXNvRmtR">https://docs.qq.com/pdf/DTm5rb2Z3UXNvRmtR</a></p>
<hr>
<p>完成</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>胡方雷
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://hufanglei.github.io/2021/09/02/elasticsearch7.X%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="elasticsearch7.X学习笔记">https://hufanglei.github.io/2021/09/02/elasticsearch7.X学习笔记/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/elasticsearch-%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># elasticsearch 数据库</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/02/elasticsearch7.x%20kibana%E7%9A%84%E5%B8%B8%E7%94%A8DSL%EF%BC%88%E8%87%AA%E5%B7%B1%E7%BB%83%E4%B9%A0%E7%9A%84%EF%BC%89/" rel="prev" title="elasticsearch7.x kibana的常用DSL（自己练习的）">
                  <i class="fa fa-angle-left"></i> elasticsearch7.x kibana的常用DSL（自己练习的）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/09/04/ElasticSearch%E4%B8%8ESpringBoot%E9%9B%86%E6%88%90-ElasticsearchRestTemplate/" rel="next" title="ElasticSearch与SpringBoot集成-ElasticsearchRestTemplate">
                  ElasticSearch与SpringBoot集成-ElasticsearchRestTemplate <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">胡方雷</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:40</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hufanglei" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
